# Maintainer: Steffen Nurpmeso <steffen@sdaoden.eu>
pkgname=bmake
pkgver=20181221
pkgrel=1
pkgdesc="Portable version of the NetBSD make build tool"
url="http://www.crufty.net/help/sjg/bmake.html"
arch="x86_64"
license="BSD"
subpackages="$pkgname-doc"
source="http://www.crufty.net/ftp/pub/sjg/bmake-$pkgver.tar.gz
	install-sh.patch
	disable-automatic-tests.patch
	"
options="!check" # FIXME: tests fail on builders
builddir="$srcdir/$pkgname"

build() {
	cd "$builddir"
	mkdir -p build
	cd build
	sh ../boot-strap op=build --with-default-sys-path=/usr/share/mk
}

check() {
	cd "$builddir/build"
	sh ../boot-strap op=test
}

package() {
	cd "$builddir/build"
	sh ../boot-strap --prefix=/usr --with-mksrc=/usr/share/mk \
			--install-destdir="$pkgdir" op=install

	rm -rf "$pkgdir"/usr/share/man/cat1
	mkdir "$pkgdir"/usr/share/man/man1
	cp ../bmake.1 "$pkgdir"/usr/share/man/man1/
	mkdir -p "$pkgdir"/usr/share/licenses/"$pkgname"
	sed -e 3,69p -e d ../main.c >\
		"$pkgdir"/usr/share/licenses/"$pkgname"/COPYING
}

sha512sums="7824fb60e4ac8f9c5ab9f6a0d42720c5f3cb475851146bf8042625eb58bbd0dbacafce6969da2b51cdd6514e789a8f2a958e8b8538cd862eeea1b571da203e5b  bmake-20181221.tar.gz
0de9022a2991c5ef02c09ab592a3e2d218cd0bbf58e54f21bc7694110f3dd9e4589bf2b3d241fd167fb220b425007863f20e71e141b4f65bf92d305ba94209da  install-sh.patch
aa20b59928b3d2a28bc407f41b56db16d6cb42d2ee8aea4ec37b2c4ef838633ac93d8fa78aaa813e9025723f394fceab379ec75860889df35e9fbe470c626e55  disable-automatic-tests.patch"
